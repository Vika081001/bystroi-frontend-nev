stages:
  - build
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store
    - .next/cache

build:
  stage: build
  tags:
    - universal
  script:
    - echo "сборка Next.js"
    
    - |
      if ! command -v pnpm >/dev/null 2>&1; then
        curl -fsSL https://get.pnpm.io/install.sh | sh -
        export PNPM_HOME="$HOME/.local/share/pnpm"
        export PATH="$PNPM_HOME:$PATH"
      fi
    
    - |
      if pnpm install --frozen-lockfile; then
        echo "Зависимости установлены"
      else
        echo "Lockfile устарел"
        pnpm install
      fi
    
    - NODE_OPTIONS="--max-old-space-size=3072" pnpm build
    
    - |
      if [ ! -d ".next/standalone" ]; then
        echo "XXX Ошибка: проверь next.config.ts - нужен output: 'standalone'"
        exit 1
      fi
      
      echo "Сборка готова"
  artifacts:
    paths:
      - .next/standalone
      - .next/static
      - public
    expire_in: 3 hours
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

deploy_production:
  stage: deploy
  tags:
    - universal
  dependencies:
    - build
  before_script:
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$DEPLOY_SERVER_PRIVATE_KEY" > ~/.ssh/deploy_key
    - chmod 600 ~/.ssh/deploy_key
    - echo -e "Host $DEPLOY_HOST\n  HostName $DEPLOY_HOST\n  User $DEPLOY_USER\n  StrictHostKeyChecking no\n  IdentityFile ~/.ssh/deploy_key" > ~/.ssh/config
  script:
    - echo "деплой"
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST "
        set -e
        
        cd /var/www/bystroi.ru/shopchik-master
        git fetch origin
        git reset --hard origin/main
        git clean -fdx
        
        if ! command -v pm2 >/dev/null 2>&1; then
          npm install -g pm2
        fi
        
        pm2 stop bystroi-app 2>/dev/null || true        
        sleep 2
        
        pm2 start .next/standalone/server.js \
          --name bystroi-app \
          --time \
          --cwd /var/www/bystroi.ru/shopchik-master
        
        pm2 save 2>/dev/null || true
        
        echo 'ожидание'
        sleep 5
        
        if curl -s http://localhost:3000 >/dev/null; then
          echo 'Сайт запущен: https://bystroi.ru'
        else
          echo '!!!  нужно проверить: pm2 logs bystroi-app'
        fi
      "
  environment:
    name: production
    url: https://bystroi.ru
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual