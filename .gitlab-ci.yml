stages:
  - build
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store
    - .next/cache

build:
  stage: build
  tags:
    - universal
  script:
    - echo "=== Сборка проекта === $(date)"
    - export PNPM_HOME="$HOME/.local/share/pnpm"
    - export PATH="$PNPM_HOME:$PATH"
    - |
      if ! command -v pnpm >/dev/null 2>&1; then
        echo "Устанавливаем pnpm..."
        curl -fsSL https://get.pnpm.io/install.sh | bash -
      fi
    - pnpm config set store-dir .pnpm-store
    - pnpm config set node-linker hoisted
    - pnpm install --frozen-lockfile || pnpm install
    - |
      if ! swapon --show | grep -q swapfile; then
        echo "Создаём swap 3 ГБ"
        sudo fallocate -l 3G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
      fi
    - NODE_OPTIONS="--max-old-space-size=3072" pnpm build
    - echo "Сборка завершена успешно!"
  rules:
    - when: always
  artifacts:
    paths:
      - .next
      - out
    expire_in: 2 hours

deploy_production:
  stage: deploy
  tags:
    - universal
  script:
    - echo "Деплой bystroi.ru $(date '+%d.%m.%Y %H:%M UTC')"
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST bash <<'EOF'
      set -e
      cd /var/www/bystroi.ru/shopchik-master
      git fetch origin && git reset --hard origin/main && git clean -fdx
      export PNPM_HOME="$HOME/.local/share/pnpm"
      export PATH="$PNPM_HOME:$PATH"
      if ! command -v pnpm >/dev/null; then
        curl -fsSL https://get.pnpm.io/install.sh | bash -
      fi
      pnpm install --frozen-lockfile || pnpm install
      NODE_OPTIONS="--max-old-space-size=3072" pnpm build
      sudo rsync -av --delete out/ /var/www/html/
      sudo chown -R www-data:www-data /var/www/html
      sudo chmod -R 755 /var/www/html
      echo "Деплой завершённых успешно!"
      EOF
  environment:
    name: production
    url: https://bystroi.ru
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual