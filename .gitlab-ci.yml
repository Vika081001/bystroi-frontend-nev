stages:
  - build
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store
    - .next/cache

build:
  stage: build
  tags:
    - universal
  script:
    - echo "=== Сборка проекта === $(date)"
    - export PNPM_HOME="$HOME/.local/share/pnpm"
    - export PATH="$PNPM_HOME:$PATH"
    - |
      if ! command -v pnpm >/dev/null 2>&1; then
        echo "Устанавливаем pnpm..."
        curl -fsSL https://get.pnpm.io/install.sh | bash -
      fi
    - pnpm config set store-dir .pnpm-store
    - pnpm config set node-linker hoisted
    - pnpm install --frozen-lockfile || pnpm install
    - |
      if ! swapon --show | grep -q swapfile; then
        echo "Создаём swap 3 ГБ"
        sudo fallocate -l 3G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
      fi
    - NODE_OPTIONS="--max-old-space-size=3072" pnpm build
    - echo "Сборка завершена успешно!"
  rules:
    - when: always
  artifacts:
    paths:
      - .next
      - public
      - next-env.d.ts
    expire_in: 2 hours

deploy_production:
  stage: deploy
  tags:
    - universal
  before_script:
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$DEPLOY_SERVER_PRIVATE_KEY" > ~/.ssh/deploy_key
    - chmod 600 ~/.ssh/deploy_key
    - echo -e "Host $DEPLOY_HOST\n    HostName $DEPLOY_HOST\n    User $DEPLOY_USER\n    StrictHostKeyChecking no\n    IdentityFile ~/.ssh/deploy_key" > ~/.ssh/config
  script:
    - echo "Деплой bystroi.ru $(date '+%d.%m.%Y %H:%M UTC')"
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST /bin/bash << 'EOF'
      set -e
      cd /var/www/bystroi.ru/shopchik-master
      
      git fetch origin && git reset --hard origin/main && git clean -fdx
      
      export PNPM_HOME="\$HOME/.local/share/pnpm"
      export PATH="\$PNPM_HOME:\$PATH"
      command -v pnpm >/dev/null 2>&1 || curl -fsSL https://get.pnpm.io/install.sh | bash -
      
      pnpm install --frozen-lockfile || pnpm install
      NODE_OPTIONS="--max-old-space-size=3072" pnpm build
      
      sudo rm -rf /var/www/html/*
      sudo mkdir -p /var/www/html/_next/static
      sudo cp -r out/* /var/www/html/ 2>/dev/null || true
      sudo cp -r public/* /var/www/html/ 2>/dev/null || true
      
      sudo chown -R www-data:www-data /var/www/html
      sudo find /var/www/html -type d -exec chmod 755 {} \;
      sudo find /var/www/html -type f -exec chmod 644 {} \;
      
      echo "Деплой завершен: https://bystroi.ru"
      EOF
  environment:
    name: production
    url: https://bystroi.ru
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual