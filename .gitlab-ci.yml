stages:
  - deploy

deploy_production:
  stage: deploy
  tags:
    - shell
  variables:
    GIT_STRATEGY: none
    GIT_SSH_URL: "git@git.tablecrm.com:tablecrm/bystroi.ru.git"

    PRODUCTION_DIR: "/var/www/bystroi.ru/shopchik-master"
    APP_NAME: "bystroi-app"
    LOG_DIR: "/var/log/bystroi.ru"

  # rules:
  #   - if: '$CI_COMMIT_BRANCH == "main"'
  #     when: manual

  script:
    - set -e
    - |
      [ -f ~/.bashrc ] && source ~/.bashrc
      [ -f ~/.profile ] && source ~/.profile

    - echo "–ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ $PRODUCTION_DIR"
    - mkdir -p $PRODUCTION_DIR
    - cd $PRODUCTION_DIR

    - |
      if [ ! -d ".git" ]; then
        echo "–ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
        git clone $GIT_SSH_URL .
      else
        echo "–û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
        git fetch origin $CI_COMMIT_BRANCH
        git reset --hard origin/$CI_COMMIT_BRANCH
        git clean -fd
      fi

    - |
      echo "--- –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js ---"
      export NVM_DIR="$HOME/.nvm"

      if [ ! -s "$NVM_DIR/nvm.sh" ]; then
        echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NVM..."
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
      fi

      \. "$NVM_DIR/nvm.sh"

      if ! command -v node >/dev/null 2>&1; then
        echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js v22..."
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π, –µ—Å–ª–∏ --lts –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
        nvm install 22
        nvm use 22
        nvm alias default 22
      fi

      export PATH="$($HOME/.nvm/nvm.sh && nvm which current | xargs dirname):$PATH"
      node -v

    - |
      if ! command -v pnpm >/dev/null 2>&1; then
        echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ pnpm..."
        curl -fsSL https://get.pnpm.io/install.sh | sh -
        export PNPM_HOME="$HOME/.local/share/pnpm"
        export PATH="$PNPM_HOME:$PATH"
      fi

    - |
      echo "--- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---"
      export HUSKY=0
      pnpm install --frozen-lockfile || pnpm install

    - |
      echo "--- –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ ---"
      NODE_OPTIONS='--max-old-space-size=2048' pnpm build

    - |
      if [ ! -d ".next/standalone" ]; then
        echo "–û—à–∏–±–∫–∞: standalone —Å–±–æ—Ä–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
        exit 1
      fi
      cp -r public .next/standalone/ || true
      mkdir -p .next/standalone/.next
      cp -r .next/static .next/standalone/.next/

    - |
      echo "--- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PM2 ---"
      if ! command -v pm2 >/dev/null 2>&1; then
        npm install -g pm2
      fi

      if [ ! -w "$LOG_DIR" ]; then
        echo "–û—à–∏–±–∫–∞: –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ $LOG_DIR. –í—ã–ø–æ–ª–Ω–∏–ª–∏ –®–∞–≥ 1 –∏–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏?"
        exit 1
      fi

      echo "--- –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---"
      pm2 delete $APP_NAME 2>/dev/null || true

      pm2 start .next/standalone/server.js \
        --name $APP_NAME \
        --time \
        --log $LOG_DIR/app.log \
        --error $LOG_DIR/error.log

      pm2 save

    - |
      echo "--- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ ---"
      sleep 5
      if curl -s http://localhost:3000 >/dev/null; then
        echo "–°–∞–π—Ç –∑–∞–ø—É—â–µ–Ω. –õ–æ–≥–∏ –≤ $LOG_DIR"
        pm2 status $APP_NAME
      else
        echo "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞. –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
        tail -n 20 $LOG_DIR/error.log
        exit 1
      fi
